<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>cMessageRouter</title><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><link rel="home" href="index.html" title="Talend Open Studio"><link rel="up" href="ch06.html" title="Chapitre&nbsp;6.&nbsp;Composants Routing"><link rel="prev" href="cMessageFilter.html" title="cMessageFilter"><link rel="next" href="cMulticast.html" title="cMulticast"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="fr" class="section" title="cMessageRouter"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cMessageRouter"></a>cMessageRouter</h2></div></div></div><div class="mediaobject"><img src="../images/cMessageRouter_icon32_white.png"></div><div class="section" title="Propri&eacute;t&eacute;s du cMessageRouter"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12985"></a>Propri&eacute;t&eacute;s du cMessageRouter</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col class="c1"><col class="c2"><col class="c3"></colgroup><tbody><tr><td valign="top"><p><span class="bold"><strong>Famille de composant</strong></span></p>
						</td><td colspan="2" valign="top"><p>Routing</p>
						</td></tr><tr><td valign="top"><p><span class="bold"><strong>Fonction</strong></span></p>
						</td><td colspan="2" valign="top"><p>Le composant <span class="bold"><strong>cMessageRouter</strong></span> route des messages dans
								diff&eacute;rents canaux selon des conditions sp&eacute;cifi&eacute;es.</p>
						</td></tr><tr><td valign="top"><p><span class="bold"><strong>Objectif</strong></span></p>
						</td><td colspan="2" valign="top"><p>Le <span class="bold"><strong>cMessageRouter</strong></span> cr&eacute;&eacute; diff&eacute;rents canaux pour chaque type de
								message filtr&eacute;, afin que les messages puissent ult&eacute;rieurement &ecirc;tre
								trait&eacute;s plus pr&eacute;cis&eacute;ment dans chaque nouveau canal.</p>
						</td></tr><tr><td valign="top"><p><span class="bold"><strong>Utilisation</strong></span></p>
						</td><td colspan="2" valign="top"><p>Le <span class="bold"><strong>cMessageRouter</strong></span> est g&eacute;n&eacute;ralement utilis&eacute; comme composant
								interm&eacute;diaire dans une Route. Il ne peut avoir qu'un seul canal
								d'entr&eacute;e mais plusieurs canaux de sortie. Les messages peuvent &ecirc;tre
								&eacute;crits en sortie via des liens de type <span class="bold"><strong>When</strong></span>, <span class="bold"><strong>Otherwise</strong></span> ou
									<span class="bold"><strong>Route</strong></span>.</p>
						</td></tr><tr><td valign="top"><p><span class="bold"><strong>Connections</strong></span></p>
						</td><td valign="top"><p><span class="emphasis"><em>Trigger / When</em></span></p>
						</td><td valign="top"><p>S&eacute;lectionnez le lien <span class="bold"><strong>When</strong></span> et cliquez sur la vue <span class="bold"><strong>Component</strong></span>.</p><p>Dans la liste <span class="bold"><strong>Type</strong></span>, s&eacute;lectionnez le type de langage que vous
								utilisez pour d&eacute;clarer votre condition.</p><p>Dans le champ <span class="bold"><strong>Condition</strong></span>, saisissez la condition &agrave; utiliser
								pour filtrer les messages.</p>
							<p>Tous les messages ne r&eacute;pondant pas &agrave; cette condition sont
								r&eacute;cup&eacute;r&eacute;es via le lien <span class="bold"><strong>Otherwise</strong></span>
								dans un canal diff&eacute;rent ou sont perdus s'il n'y a pas de lien
									<span class="bold"><strong>Otherwise</strong></span>.</p>
							<p>
								</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="16pt"><img alt="[Note]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Il peut y avoir plusieurs liens <span class="bold"><strong>When</strong></span> dans une Route.</p></td></tr></table></div><p>
							</p>
						</td></tr><tr><td><p>&nbsp;</p>
						</td><td valign="top"><p><span class="emphasis"><em>Trigger / Otherwise</em></span></p>
						</td><td valign="top"><p>Ce lien r&eacute;cup&egrave;re automatiquement les messages ne remplissant pas les conditions <span class="bold"><strong>When</strong></span>. </p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="16pt"><img alt="[Note]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Il ne peut y avoir qu'un lien <span class="bold"><strong>Otherwise</strong></span>, facultatif, dans une
										Route.</p></td></tr></table></div>
						</td></tr><tr><td valign="top"><p><span class="bold"><strong>Limitation</strong></span></p>
						</td><td colspan="2"><p>Il n'est pas recommand&eacute; d'effectuer de gestion de message apr&egrave;s un lien <span class="bold"><strong>when</strong></span> ou <span class="bold"><strong>otherwise</strong></span>.
								Utilisez toujours un endpoint Mock/Direct pour les remplacer et
								cr&eacute;ez une nouvelle Route pour g&eacute;rer les messages</p>
						</td></tr></tbody></table></div></div><div class="section" title="Sc&eacute;nario : Router des messages selon un crit&egrave;re"><div class="titlepage"><div><div><h3 class="title"><a name="Raa16067"></a>Sc&eacute;nario : Router des messages selon un crit&egrave;re</h3></div></div></div><p>Dans ce sc&eacute;nario, vous routez des messages XML envoy&eacute;s de l'endpoint &eacute;metteur selon un
			crit&egrave;re d&eacute;fini : les fichiers XML dans lesquels la valeur du n&#339;ud
				<span class="emphasis"><em>city</em></span> est <span class="emphasis"><em>Paris</em></span> sont envoy&eacute;s dans un
			dossier nomm&eacute; <span class="emphasis"><em>Paris_only</em></span> et les autres messages sont envoy&eacute;s dans
			un dossier nomm&eacute; <span class="italic">Others_cities</span>.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario1.png"></div><p>Parmi les quatre fichiers XML utilis&eacute;s dans ce sc&eacute;nario, <span class="italic">Message_1.xml</span> et <span class="italic">Message_4.xml</span>
			contiennent le nom de la ville de <span class="italic">Paris</span>. Voici un
			exemple :</p><pre class="programlisting">&lt;person&gt;
  &lt;firstName&gt;Pierre&lt;/firstName&gt;
  &lt;lastName&gt;Dupont&lt;/lastName&gt;
  &lt;city&gt;Paris&lt;/city&gt;
&lt;/person&gt;</pre><div class="section" title="D&eacute;poser et relier les composants"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13175"></a>D&eacute;poser et relier les composants</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="&Eacute;tape 1"><p>De la famille <span class="bold"><strong>Messaging</strong></span> de la <span class="bold"><strong>Palette</strong></span>, d&eacute;posez trois composants <span class="bold"><strong>cFile</strong></span> et quatre <span class="bold"><strong>cMessagingEndpoint</strong></span> dans l'espace de mod&eacute;lisation graphique
						et nommez-les respectivement <span class="italic">Sender</span>,
							<span class="italic">Receiver_Paris</span> et <span class="italic">Receiver_Others</span>, pour les <span class="bold"><strong>cFile</strong></span>, et <span class="italic">directParis</span>,
							<span class="italic">directOthers</span>, <span class="italic">directParisRoute</span> et <span class="italic">directOthersRoute</span> afin de mieux identifier leur r&ocirc;le.</p></li><li class="step" title="&Eacute;tape 2"><p>De la famille <span class="bold"><strong>Routing</strong></span>, d&eacute;posez un composant <span class="bold"><strong>cMessageRouter</strong></span> dans l'espace de mod&eacute;lisation
						graphique et nommez-le <span class="italic">Message_router</span>.</p></li><li class="step" title="&Eacute;tape 3"><p>De la famille <span class="bold"><strong>Miscellaneous</strong></span>, d&eacute;posez deux
						composants <span class="bold"><strong>tLogRow</strong></span> dans l'espace de
						mod&eacute;lisation graphique et nommez-les <span class="italic">Monitor_Paris</span> et <span class="italic">Monitor_Others</span>, respectivement.</p></li><li class="step" title="&Eacute;tape 4"><p>Cliquez-droit sur le composant <span class="bold"><strong>cFile</strong></span> nomm&eacute; <span class="italic">Sender</span>, s&eacute;lectionnez <span class="bold"><strong>Row</strong></span> &gt; <span class="bold"><strong>Route</strong></span> dans le menu
						contextuel et cliquez sur le composant <span class="bold"><strong>cMessageRouter</strong></span>. </p></li><li class="step" title="&Eacute;tape 5"><p>Cliquez-droit sur le <span class="bold"><strong>cMessageRouter</strong></span>, s&eacute;lectionnez
							<span class="bold"><strong>Trigger</strong></span> &gt; <span class="bold"><strong>When</strong></span> dans le menu contextuel et cliquez sur le composant
							<span class="bold"><strong>cMessagingEndpoint</strong></span> nomm&eacute; <span class="italic">directParis</span>. Cet endpoint va r&eacute;cup&eacute;rer les
						messages r&eacute;pondant au crit&egrave;re d&eacute;fini.</p></li><li class="step" title="&Eacute;tape 6"><p>Cliquez-droit sur le composant <span class="bold"><strong>cMessageRouter</strong></span>,
						s&eacute;lectionnez <span class="bold"><strong>Trigger</strong></span> &gt; <span class="bold"><strong>Otherwise</strong></span> dans le menu contextuel et cliquez sur
						le <span class="bold"><strong>cMessagingEndpoint</strong></span> nomm&eacute; <span class="italic">directOther</span>. Cet endpoint va collecter tous les
						messages ne r&eacute;pondant pas au crit&egrave;re de filtre.</p></li><li class="step" title="&Eacute;tape 7"><p>Cliquez-droit sur le composant <span class="bold"><strong>cMessagingEndpoint</strong></span> nomm&eacute;
							<span class="italic">directParis</span>, s&eacute;lectionnez <span class="bold"><strong>Row</strong></span> &gt; <span class="bold"><strong>Route</strong></span> dans
						le menu contextuel et cliquez sur le <span class="bold"><strong>cFile</strong></span>
						nomm&eacute; <span class="italic">Receiver_Paris</span>. R&eacute;p&eacute;tez cette &eacute;tape
						pour relier le composant <span class="italic">Receiver_Paris</span>
						au <span class="italic">Monitor_Paris</span>, le <span class="italic">directOthersRoute</span> au <span class="italic">Receiver_Others</span> et le <span class="italic">Receiver_Others</span> au <span class="italic">Monitor_Others</span>, &agrave; l'aide de liens <span class="bold"><strong>Row</strong></span> &gt; <span class="bold"><strong>Route</strong></span>.</p></li></ol></div></div><div class="section" title="Configurer les composants et les connexions"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13344"></a>Configurer les composants et les connexions</h4></div></div></div><p>Le composant <span class="bold"><strong>cMessageRouter</strong></span> ne poss&egrave;de pas de propri&eacute;t&eacute;s
				car il filtre et route les messages d'un endpoint aux autres selon les conditions
				d&eacute;finies dans les liens <span class="bold"><strong>When</strong></span>.</p><div class="procedure"><ol class="procedure" type="1"><li class="step" title="&Eacute;tape 1"><p>Double-cliquez sur le composant <span class="bold"><strong>cFile</strong></span> nomm&eacute; <span class="italic">Sender</span> pour ouvrir sa vue <span class="bold"><strong>Basic settings</strong></span>.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario2.png"></div></li><li class="step" title="&Eacute;tape 2"><p>Dans le champ <span class="bold"><strong>Path</strong></span>, sp&eacute;cifiez le chemin d'acc&egrave;s &agrave; la
						source du message.</p><p>Dans la liste <span class="bold"><strong>Encoding</strong></span>, s&eacute;lectionnez le type d'encodage
						de vos fichiers de messages. Laissez les autres param&egrave;tres tels qu'ils
						sont.</p></li><li class="step" title="&Eacute;tape 3"><p>Dans l'espace de mod&eacute;lisation graphique, cliquez sur le lien <span class="bold"><strong>When</strong></span> cr&eacute;&eacute; et cliquez sur la vue <span class="bold"><strong>Component</strong></span> pour d&eacute;finir un filtre par rapport auquel les
						messages seront rout&eacute;s.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario6.png"></div></li><li class="step" title="&Eacute;tape 4"><p>Dans la liste <span class="bold"><strong>Type</strong></span>, s&eacute;lectionnez <span class="bold"><strong>xpath</strong></span> car le format des messages utilis&eacute;s est XML.</p><p>Dans le champ <span class="bold"><strong>Condition</strong></span>, saisissez
							<code class="code">"/person[city='Paris']"</code> pour r&eacute;cup&eacute;rer uniquement les
						messages dans lesquels la valeur du n&#339;ud <span class="emphasis"><em>city</em></span> est
							<span class="emphasis"><em>Paris</em></span>.</p></li><li class="step" title="&Eacute;tape 5"><p>Double-cliquez sur le composant <span class="bold"><strong>cMessagingEndpoint</strong></span> nomm&eacute;
							<span class="italic">directParis</span> pour ouvrir sa vue
							<span class="bold"><strong>Basic settings</strong></span>. </p><div class="mediaobject"><img src="../images/cmessagerouter_scenario4.png"></div></li><li class="step" title="&Eacute;tape 6"><p>Dans le champ <span class="bold"><strong>URI</strong></span>, saisissez l'URL de
						l'endpoint, par exemple <span class="italic">"direct:Paris"</span>,
						afin de recevoir le message filtr&eacute;.</p></li><li class="step" title="&Eacute;tape 7"><p>R&eacute;p&eacute;tez ces &eacute;tapes afin de configurer l'URI des composants <span class="bold"><strong>cMessagingEndpoint</strong></span>. L'URL du composant <span class="italic">directOthers</span> est <span class="italic">direct:Others</span>, celle du <span class="italic">directParisRoute</span> est <span class="italic">direct:Paris</span> et celle du <span class="italic">directOthersRoute</span> est <span class="italic">direct:Others</span>.</p></li><li class="step" title="&Eacute;tape 8"><p>Double-cliquez sur le composant <span class="bold"><strong>cFile</strong></span>
						nomm&eacute; <span class="italic">Receiver_Paris</span> pour ouvrir sa vue
							<span class="bold"><strong>Component</strong></span> et sp&eacute;cifiez le chemin
						d'acc&egrave;s aux messages r&eacute;pondant au crit&egrave;re de filtre, dans le champ <span class="bold"><strong>Path</strong></span>.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario3.png"></div><p>R&eacute;p&eacute;tez cette &eacute;tape pour d&eacute;finir le chemin d'acc&egrave;s &agrave; tous les messages de
						l'&eacute;metteur dans le composant <span class="bold"><strong>cFile</strong></span> nomm&eacute;
							<span class="italic">Receive_Other</span>.</p></li><li class="step" title="&Eacute;tape 9"><p>Double-cliquez sur le composant <span class="bold"><strong>cLog</strong></span> nomm&eacute; <span class="italic">Monitor_Paris</span> pour ouvrir sa vue <span class="bold"><strong>Basic settings</strong></span>.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario5.png"></div></li><li class="step" title="&Eacute;tape 10"><p>Dans la liste <span class="bold"><strong>Level</strong></span>, s&eacute;lectionnez <span class="bold"><strong>INFO</strong></span>. S&eacute;lectionnez l'option <span class="bold"><strong>Specify
							output log message</strong></span> et saisissez le code suivant dans le champ
							<span class="bold"><strong>Message</strong></span> pour afficher le nom de fichier
						du message envoy&eacute; vers le r&eacute;pertoire sp&eacute;cifi&eacute;.</p><pre class="programlisting">Message sent to folder Paris_only: ${header.CamelFileNameOnly}</pre><p>R&eacute;p&eacute;tez cette &eacute;tape pour personnaliser le message dans le composant <span class="bold"><strong>cLog</strong></span> nomm&eacute; <span class="italic">Monitor_Others</span>
						pour afficher les noms de fichiers du message vers le r&eacute;pertoire
						sp&eacute;cifi&eacute;.</p></li><li class="step" title="&Eacute;tape 11"><p>Appuyez sur <span class="bold"><strong>Ctrl+S</strong></span> pour sauvegarder votre Route.</p></li></ol></div></div><div class="section" title="Visualiser du code et ex&eacute;cuter la Route"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13537"></a>Visualiser du code et ex&eacute;cuter la Route</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="&Eacute;tape 1"><p>Cliquez sur l'onglet <span class="bold"><strong>Code</strong></span> au bas de l'espace de
						mod&eacute;lisation graphique afin de visualiser le code g&eacute;n&eacute;r&eacute;.</p><div class="mediaobject"><img src="../images/cmessagerouter_scenario7.png"></div><p>Comme affich&eacute; dans le code, les messages sont rout&eacute;s selon des conditions initialis&eacute;es
						par le morceau de code <code class="code">.choice()</code>, le filtre d&eacute;fini est
						initialis&eacute; par le morceau de code <code class="code">.when()</code> et les messages non
						filtr&eacute;s sont rout&eacute;s via le morceau de code <code class="code">.otherwise()</code>. </p></li><li class="step" title="&Eacute;tape 2"><p>Cliquez sur le bouton <span class="bold"><strong>Run</strong></span> de la vue <span class="bold"><strong>Run</strong></span> ou appuyez sur <span class="bold"><strong>F6</strong></span> pour ex&eacute;cuter votre Route. </p><p>R&eacute;sultat : Les fichiers contenant &#8220;<span class="italic">Paris</span>&#8221;sont envoy&eacute;s
						dans le dossier nomm&eacute; <span class="emphasis"><em>Paris_only</em></span> et les autres messages
						sont envoy&eacute;s dans un dossier nomm&eacute; <span class="emphasis"><em>Others_cities</em></span>. </p><div class="mediaobject"><img src="../images/cmessagerouter_scenario8.png"></div></li></ol></div></div></div></div></body></html>